data "authentik_group" "all" {
  for_each = {
    for item in flatten([
      for level, level_group_detail in var.groups_info : [
        for group_name, group_detail in level_group_detail : {
          key    = group_name
          group_name = group_name
        }
      ]
    ]) : item.key => item
  }

  name = each.key
  depends_on = [
    authentik_group.groups_level1,
    authentik_group.groups_level2,
    authentik_group.groups_level3,
    authentik_group.groups_level4,
    authentik_group.groups_level5
  ]
}

resource "authentik_user" "user" {
  for_each = {
    for item in flatten([
      for username, user_detail in var.users_info : [
        {
          key       = username
          name      = user_detail.name
          password  = user_detail.password
          email     = user_detail.email
          type      = user_detail.type
          is_active = user_detail.is_active
          groups_id = [
            for group in user_detail.groups :
              data.authentik_group.all[group].id
          ]
        }
      ]
    ]) : item.key => item
  }

  username  = each.key
  name      = each.value.name
  password  = each.value.password
  email     = each.value.email
  type      = each.value.type
  is_active = each.value.is_active
  groups    = each.value.groups_id

  depends_on = [data.authentik_group.all]
}