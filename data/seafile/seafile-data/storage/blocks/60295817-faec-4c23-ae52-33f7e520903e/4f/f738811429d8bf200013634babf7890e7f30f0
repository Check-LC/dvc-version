resource "rancher2_cluster_v2" "custom_cluster" {
  name               = var.cluster_name
  kubernetes_version = var.kubernetes_version
  cluster_agent_deployment_customization {}
  fleet_agent_deployment_customization {}
  rke_config {
    chart_values          = <<EOF
rke2-cilium: {}
EOF
    machine_global_config = <<EOF
cni: "cilium"
disable-kube-proxy: false
etcd-expose-metrics: false
EOF
    machine_selector_config {
      config = <<EOF
protect-kernel-defaults: false
system-default-registry: docker.io
EOF
    }
    registries {
      mirrors {
        hostname  = "docker.io"
        endpoints = ["https://nexus.inboc.net/repository/docker/v2/"]
      }
      mirrors {
        hostname  = "nvcr.io"
        endpoints = ["https://nexus.inboc.net/repository/docker/v2/"]
      }
    }
    upgrade_strategy {
      control_plane_concurrency = "1"
      control_plane_drain_options {
        delete_empty_dir_data                = true
        disable_eviction                     = false
        enabled                              = false
        force                                = false
        grace_period                         = -1
        ignore_daemon_sets                   = true
        ignore_errors                        = false
        skip_wait_for_delete_timeout_seconds = 0
        timeout                              = 120
      }
      worker_concurrency = "1"
      worker_drain_options {
        delete_empty_dir_data                = true
        disable_eviction                     = false
        enabled                              = true
        force                                = false
        grace_period                         = -1
        ignore_daemon_sets                   = true
        ignore_errors                        = false
        skip_wait_for_delete_timeout_seconds = 0
        timeout                              = 120
      }
    }
    etcd {
      snapshot_schedule_cron = "0 */5 * * *"
      snapshot_retention     = 5
    }
  }
  lifecycle {
    ignore_changes = [
      rke_config[0].upgrade_strategy[0].control_plane_drain_options[0].grace_period,
      rke_config[0].upgrade_strategy[0].worker_drain_options[0].grace_period,
    ]
  }
}