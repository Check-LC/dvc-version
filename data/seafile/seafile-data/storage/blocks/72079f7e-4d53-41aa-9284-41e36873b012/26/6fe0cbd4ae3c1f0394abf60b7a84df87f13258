## 1. ldap-account-manager
### 1.1 Repo URL
- https://gabibbo97.github.io/charts/
- tag：changes in the chart.yaml
### 1.2 Values Modify----values.yaml
```
extraEnv:
  LAM_SKIP_PRECONFIGURE: false
  LDAP_DOMAIN: inboc.net;ibswufe.com
  LDAP_BASE_DN: dc=inboc,dc=net;dc=ibswufe,dc=com
  LDAP_SERVER: ldaps://ldap01.inboc.net
  LDAP_USER: cn=administrator,dc=inboc,dc=net
  LAM_LANG: zh_CN
  LAM_PASSWORD: lam
```


## 2. self-service-password
### 2.1 Repo URL
- https://ygqygq2.github.io/charts/
- Set image tag:5.3.3 to pull the latest one
### 2.2 Charts Using
#### 2.2.1 ENV Setting ConfigMap
- So confused about why I cannot make it effective when using the ConfigMap settings on values.yaml to cover the default PHP configurations of this software.
- So , Using  ConfigMap Data to  define the container environment variables of this chart.
- env-config.yaml
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
name: self-service-password-env
data:
    USE_QUESTIONS: 'false'
	LDAP_BINDDN: "cn=inbocadmin,dc=inboc,dc=net"
	SECRETEKEY: "inboc"
	DEFAULT_ACTION: "sendtoken"
	LANG: "cn,zh-CN"
	IS_BEHIND_PROXY: 'true'
	SITE_URL: "https://ssp.inboc.net/index.php"
	LDAP_SERVER: "ldap://10.13.3.107"
	LDAP_BASE_SEARCH: "ou=inboc,dc=inboc,dc=net"
	LDAP_LOGIN_ATTRIBUTE: "cn"
	LOGO: images/mnt/ltb-logo.png                                  # 共享存储，挂载在容器中的/www/ssp/images/mnt
	BACKGROUND_IMAGE: images/mnt/background.jpg
	MAIL_FROM_NAME: "密码自主修改服务"
	MAIL_SIGNATURE: "如有疑问,请联系运维同事,英博智云."
	MAIL_USE_LDAP: 'true'
	NOTIFY_ON_CHANGE: 'true'
	SMTP_AUTH_ON: 'true'
	SMTP_HOST: "smtphz.qiye.163.com"
	MAIL_FROM: "chao.long@inboc.net"
	SMTP_USER: "chao.long@inboc.net"
	SMTP_SECURE_TYPE: 'ssl'
	SMTP_PORT: '465'
	SMTP_AUTOTLS: 'false'
	PASSWORD_DIFFERENT_LOGIN: 'true'
	PASSWORD_MAX_LENGTH: '30'
	PASSWORD_MIN_LENGTH: '8'
	PASSWORD_MIN_LOWERCASE: '1'
	PASSWORD_MIN_SPECIAL: '1'
	PASSWORD_MIN_UPPERCASE: '1'
	PASSWORD_COMPLEXITY: '4'
	PASSWORD_NO_REUSE: "true"
	PASSWORD_SHOW_POLICY: "always"
	PASSWORD_SPECIAL_CHARACTERS: "^a-zA-Z0-9"
```

- add a field `envFrom`  under the `env` in templates/deployment-statefulset.yaml
```
env:
{{ toYaml .Values.env | indent 12 }}
envFrom:
- configMapRef:
    name: self-service-password-env
```
#### 2.2.2 Secret
- there are two variables need to been encrypted
- values.secret
```
secret:
  enabled: true
  mountPath: /etc/secret-volume
  subPath: ""
  readOnly: true
  data:
    ldap_bindpass: "Inboc@2020"
    smtp_pass: "WaLxeu3pvsQaqd7X"
```
#### 2.2.3 values.env
```
env:
  - name: LDAP_BINDPASS
    valueFrom:
      secretKeyRef:
        name: self-service-password
        key: ldap_bindpass
  - name: SMTP_PASS
    valueFrom:
      secretKeyRef:
        name: self-service-password
        key: smtp_pass
```

#### 2.2.4 persistentVolume 
- create  pv & pvc resources under this namespace，mount the volume ，name: self-service-password
```
persistentVolume:   # 是否存储持久化
  enabled: true
  storageClass: "-"
  accessMode: ReadWriteOnce
  annotations: {}
  size: 1Gi  # 大小
  existingClaim: {}  # 使用已存在的pvc
  mountPaths:
   - name: data-storage
     mountPath: /www/ssp/images/mnt  # 容器内路径，将新建 mnt
     subPath: ssp-nfs                               # pv 中挂载点下的子目录
```

- pv.yaml
```
apiVersion: v1
kind: PersistentVolume
metadata:
  name: self-service-password
spec:
  capacity:
    storage: 1Gi
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  nfs:
    path: /home/inboc/nfs # 指定nfs的挂载点
    server: 10.13.3.108
```

- Post  test，reverse proxy by nginx using Nodeport。Setting the dns resolving，take a visit of this site。
```
upstream ssp {
  server 10.13.3.109:32337;
}
server {
    listen 80;
    server_name ssp.inboc.net;
    return 301 https://$server_name$request_uri;
}
server {
    listen 443 ssl ;
    server_name ssp.inboc.net;
    ssl_certificate tls/tls_ca.pem; 
    ssl_certificate_key tls/tls_key.pem;
    location / {
      proxy_pass http://ssp;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto "https";
      proxy_read_timeout 1800s;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
    }
}
```

- chart value correction
`utcook.fullname`  change into--> `self-service-password.fullname`

## 3. 测试用到的 ENV 书写
- v1的 config.php
```
$DEFAULT_ACTION = "sendtoken";

$BACKGROUND_IMAGE = "";

$LOGO = "";

$LANG = "cn,zh-CN";

$IS_BEHIND_PROXY = true;

$SITE_URL = "https://ssp.inboc.net";

// LDAP

$LDAP_SERVER = "ldap://10.13.3.107";

$LDAP_BINDDN = "cn=admin,dc=inboc,dc=net";

$LDAP_BASE_SEARCH = "dc=inboc,dc=net";

$LDAP_FILTER = "(&(objectClass=inetOrgPerson)($ldap_fullname_attribute={login}))";

  
  

// MAIL

$MAIL_FROM_NAME = "密码自主修改服务";

$MAIL_SIGNATURE = "如有疑问,请联系运维同事,英博智云.";

$MAIL_USE_LDAP = true;

$NOTIFY_ON_CHANGE = true;

$SMTP_AUTH_ON = true;

$SMTP_HOST = 'smtphz.qiye.163.com';

$MAIL_FROM = "chao.long@inboc.net";

$SMTP_USER = "chao.long@inboc.net";

$SMTP_SECURE_TYPE = 'ssl';

$SMTP_PORT = 465;

$SMTP_AUTOTLS = false;

  

// Password Policy

$PASSWORD_DIFFERENT_LOGIN = true;

$PASSWORD_MAX_LENGTH = 30;

$PASSWORD_MIN_LENGTH = 8;

$PASSWORD_MIN_DIGIT = 1;

$PASSWORD_MIN_LOWERCASE = 1;

$PASSWORD_MIN_SPECIAL = 1;

$PASSWORD_MIN_UPPERCASE = 1;

$PASSWORD_COMPLEXITY = 4;

$PASSWORD_NO_REUSE = true;

$PASSWORD_SHOW_POLICY= "always";

$PASSWORD_SPECIAL_CHARACTERS = "^a-zA-Z0-9";
```

- v2的ENV，生效成功
```
- name: SETUP_TYPE
    value: 
  - name: LDAP_BINDDN
    value: "cn=inbocadmin,dc=inboc,dc=net"
  - name: LDAP_BINDPASS
    valueFrom:
      secretKeyRef:
        name: self-service-password
        key: ldap_bindpass
  - name: DEFAULT_ACTION
    value: "sendtoken"
  - name: LANG
    value: "cn,zh-CN"
  - name: IS_BEHIND_PROXY
    value: "true"
  - name: SITE_URL
    value: "https://ssp.inboc.net/index.php"
  - name: LDAP_SERVER
    value: "ldap://10.13.3.107"
  - name: LDAP_BASE_SEARCH
    value: "ou=inboc,dc=inboc,dc=net"
  - name: LDAP_LOGIN_ATTRIBUTE
    value: "cn"
  - name: LOGO
    value: "https://www.inboc.net/static/picture/black_blue_big.png"
  - name: MAIL_FROM_NAME
    value: "密码自主修改服务"
  - name: MAIL_SIGNATURE
    value: "如有疑问,请联系运维同事,英博智云."
  - name: MAIL_USE_LDAP
    value: "true"
  - name: NOTIFY_ON_CHANGE
    value: "true"
  - name: SMTP_AUTH_ON
    value: "true"
  - name: SMTP_HOST
    value: "smtphz.qiye.163.com"
  - name: MAIL_FROM
    value: "chao.long@inboc.net"
  - name: SMTP_USER
    value: "chao.long@inboc.net"
  - name: SMTP_SECURE_TYPE
    value: 'ssl'
  - name: SMTP_PORT
    value: '465'
  - name: SMTP_AUTOTLS
    value: "false"
  - name: PASSWORD_DIFFERENT_LOGIN
    value: "true"
  - name: PASSWORD_MAX_LENGTH
    value: '30'
  - name: PASSWORD_MIN_LENGTH
    value: '8'
  - name: PASSWORD_MIN_DIGIT
    value: '1'
  - name: PASSWORD_MIN_LOWERCASE
    value: '1'
  - name: PASSWORD_MIN_SPECIAL
    value: '1'
  - name: PASSWORD_MIN_UPPERCASE
    value: '1'
  - name: PASSWORD_COMPLEXITY
    value: '4'
  - name: PASSWORD_NO_REUSE
    value: "true"
  - name: PASSWORD_SHOW_POLICY
    value: "always"
  - name: PASSWORD_SPECIAL_CHARACTERS
    value: "^a-zA-Z0-9"
  - name: SMTP_PASS
    valueFrom: 
      secretKeyRef:
        name: self-service-password
        key: smtp_pass
  - name: SECRETEKEY
    value: "inboc"
  - name: DEBUG_MODE
    value: "false"
```

```
apiVersion: v1

kind: ConfigMap

metadata:

name: self-service-password-env

namespace: test

data:

LDAP_BINDDN: "cn=inbocadmin,dc=inboc,dc=net"

SECRETEKEY: "inboc"

DEFAULT_ACTION: "sendtoken"

LANG: "cn,zh-CN"

IS_BEHIND_PROXY: "true"

SITE_URL: "https://ssp.inboc.net/index.php"

LDAP_SERVER: "ldap://10.13.3.107"

LDAP_BASE_SEARCH: "ou=inboc,dc=inboc,dc=net"

LDAP_LOGIN_ATTRIBUTE: "cn"

LOGO: "https://www.inboc.net/static/picture/black_blue_big.png"

MAIL_FROM_NAME: "密码自主修改服务"

MAIL_SIGNATURE: "如有疑问,请联系运维同事,英博智云."

MAIL_USE_LDAP: "true"

NOTIFY_ON_CHANGE: "true"

SMTP_AUTH_ON: "true"

SMTP_HOST: "smtphz.qiye.163.com"

MAIL_FROM: "chao.long@inboc.net"

SMTP_USER: "chao.long@inboc.net"

SMTP_SECURE_TYPE: 'ssl'

SMTP_PORT: '465'

SMTP_AUTOTLS: "false"

PASSWORD_DIFFERENT_LOGIN: "true"

PASSWORD_MAX_LENGTH: '30'

PASSWORD_MIN_LENGTH: '8'

PASSWORD_MIN_LOWERCASE: '1'

PASSWORD_MIN_SPECIAL: '1'

PASSWORD_MIN_UPPERCASE: '1'

PASSWORD_COMPLEXITY: '4'

PASSWORD_NO_REUSE: "true"

PASSWORD_SHOW_POLICY: "always"

PASSWORD_SPECIAL_CHARACTERS: "^a-zA-Z0-9"
```